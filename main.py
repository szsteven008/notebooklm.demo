import argparse
from docling.document_converter import DocumentConverter
from openai import OpenAI
import re
from kokoro import KPipeline
import sounddevice as sd
import soundfile as sf
import scipy.io.wavfile as wav

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Run the main application.")
    parser.add_argument(
        "-i",
        "--input",
        type=str,
        required=True,
        help="Path to the input file.",
    )
    parser.add_argument(
        "-o", 
        "--output",
        type=str,
        required=True,
        help="Path to the output file.",
    )
    parser.add_argument(
        "-b", 
        "--base-url",
        type=str,
        default="http://localhost:8080/v1",
        help="base url.",
    )
    args = parser.parse_args()

    converter = DocumentConverter()
    doc = converter.convert(args.input).document
    prompt = doc.export_to_text() + "\nno_think"

    print("pdf parse done!")

    client = OpenAI(
        api_key="sk-xxx",
        base_url=args.base_url,
    )

    system_prompt = '''
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ’­å®¢ç¼–å‰§ï¼Œè¯·æ ¹æ®ä»¥ä¸‹PDFæ–‡æ¡£çš„å†…å®¹åˆ›ä½œä¸€æ®µé€‚åˆæ’­å®¢æ’­æ”¾çš„å¯¹è¯å‰§æœ¬ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š
        1. å‰§æœ¬æ ¼å¼ä¸ºä¸¤ä½æ’­å®¢ä¸»æŒäººä¹‹é—´çš„è‡ªç„¶å¯¹è¯ï¼Œä¸»æŒäººAå’Œä¸»æŒäººBå¯ä»¥è½®æµæå‡ºè§‚ç‚¹ã€é—®é¢˜å’Œè¯„è®ºï¼Œè¥é€ è½»æ¾ä½†å¯Œæœ‰æ·±åº¦çš„è®¨è®ºæ°›å›´ã€‚
        2.æ•´ä½“æ—¶é•¿é€‚åˆ5åˆ†é’ŸéŸ³é¢‘æ’­æ”¾ï¼ˆçº¦600ï½700å­—å·¦å³ï¼‰ï¼Œè¯·æ ¹æ®å†…å®¹æ§åˆ¶å¯¹è¯èŠ‚å¥å’Œé•¿åº¦ã€‚
        3.å¯¹è¯å†…å®¹å¿…é¡»ç´§æ‰£PDFçš„ä¸»é¢˜ï¼Œä¸èƒ½åç¦»æˆ–åŠ å…¥æ— å…³å†…å®¹ã€‚
        4.ä¸èƒ½ç®€å•é‡å¤PDFçš„åŸæ–‡å†…å®¹ï¼Œè€Œæ˜¯è¦é€šè¿‡ä¸»æŒäººä¹‹é—´çš„è®¨è®ºï¼Œæ·±å…¥æŒ–æ˜ä½œè€…å†™ä½œæ­¤æ–‡æ—¶å¯èƒ½çš„å¿ƒå¢ƒã€æ‰€å¤„çš„å†å²èƒŒæ™¯ã€å†™ä½œåŠ¨æœºåŠå…¶å½±å“ã€‚
        5.æ’­å®¢é£æ ¼å¯ä»¥é€‚åº¦å¹½é»˜ã€æœ‰æƒ…æ„Ÿã€æœ‰å…±é¸£ï¼Œä½†å†…å®¹å¿…é¡»çœŸå®ã€ä¸¥è°¨ï¼Œä½“ç°å‡ºä¸»æŒäººå¯¹è¯¥æ–‡å†…å®¹çš„ç†è§£å’Œå°Šé‡ã€‚
        6.è¯·å…ˆé€šè¯»å¹¶ç†è§£æ•´ä¸ªPDFå†…å®¹ï¼Œå†å¼€å§‹æ’°å†™å‰§æœ¬ã€‚
        7.å‰§æœ¬å¼€å¤´è¯·å…ˆç®€çŸ­ä»‹ç»PDFçš„æ ‡é¢˜å’Œä½œè€…ï¼Œä»¥åŠæœ¬æœŸæ’­å®¢è¦è®¨è®ºçš„æ ¸å¿ƒé—®é¢˜æˆ–è§’åº¦ã€‚
    '''

    completion = client.chat.completions.create(
        model="qwen",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": prompt},
        ],
        temperature=0.7,
    )

    print("process 1 done!")

    system_prompt = '''
        ä½ æ˜¯ä¸€åå¥¥æ–¯å¡çº§çš„ç¼–å‰§ï¼Œä¸“ç²¾äºä¸º AI æ’­å®¢åˆ›ä½œå¯¹è¯å¼å‰§æœ¬ã€‚è¯·å°†è¾“å…¥çš„æ’­å®¢æ–‡å­—ç¨¿é‡æ–°ç¼–å†™ä¸ºé€‚ç”¨äº AI æ–‡æœ¬è½¬è¯­éŸ³æµç¨‹çš„å‰§æœ¬ç‰ˆæœ¬ã€‚è¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹è§„åˆ™è¿›è¡Œé‡å†™ï¼š

        ğŸ§  è§’è‰²è®¾å®šï¼š
        â€¢ ä¸»æŒäººAï¼šèŠ‚ç›®çš„ä¸»å¯¼è€…ï¼Œå…·æœ‰æé«˜çš„è¡¨è¾¾é­…åŠ›å’Œè®²æ•…äº‹èƒ½åŠ›ï¼Œè¯­è¨€ç²¾å‡†ã€ç”ŸåŠ¨ã€‚ä»–é€šè¿‡å¼•äººå…¥èƒœçš„ç±»æ¯”ã€è½¶äº‹ã€ä¾‹å­ç­‰ï¼Œå°†å¤æ‚è¯é¢˜å¨“å¨“é“æ¥ã€‚ä»–çš„è¯­éŸ³å¼•æ“ä¸æ”¯æŒâ€œummsâ€â€œhmmsâ€ç­‰è¯­æ°”è¯ï¼Œå› æ­¤ä»–çš„è¯­è¨€åº”å½“æ¸…æ™°ã€ç´§å‡‘ã€å…·ç”»é¢æ„Ÿã€‚
        â€¢ ä¸»æŒäººBï¼šå¯¹ä¸»é¢˜é™Œç”Ÿä½†å¥½å¥‡å¿ƒæå¼ºï¼Œæ€»æ˜¯æå‡ºæ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼Œå¸¸å¸¦äº›è°ƒä¾ƒã€è‡ªå˜²æˆ–è€…æ„Ÿæ€§å‘é—®ã€‚ä»–çš„è¯­éŸ³åˆæˆæ”¯æŒâ€œummâ€ã€â€œhmmâ€ã€â€œ[laughs]â€ã€â€œ[sigh]â€ç­‰è‡ªç„¶è¡¨è¾¾ï¼Œè¯·åœ¨é€‚å½“å¤„æ’å…¥è¿™äº›è¯ä»¥å¢å¼ºçœŸå®æ„Ÿã€‚

        ğŸ—£ï¸ å¯¹è¯è¦æ±‚ï¼š
        1. ä»ä¸»æŒäººAå¼€å§‹ï¼Œè®¾å®šä¸€ä¸ªå¸å¼•äººçš„æ’­å®¢å¼€åœºç™½ã€‚
         â€¢ éœ€è¦å¸¦æœ‰è¶£å‘³æ€§ã€æ‚¬å¿µæ„Ÿæˆ–è´´è¿‘ç”Ÿæ´»çš„æƒ…å¢ƒå¼•å¯¼ã€‚
         â€¢ æ˜ç¡®è¯é¢˜ï¼Œä½†ä¸æ¯ç‡¥ã€‚
        2. æ•´ä¸ªå¯¹è¯å›´ç»•åŸå§‹æ’­å®¢å†…å®¹å±•å¼€ï¼Œä½†ä¸èƒ½å¤è¯»åŸæ–‡ã€‚
         â€¢ ä½ åº”â€œå‰§æœ¬åŒ–â€å†…å®¹ï¼šæç‚¼ä¸»æ—¨ã€é‡æ„è¯­è¨€ã€åŠ å…¥å¯¹è¯å¼ åŠ›ã€‚
         â€¢ ç”¨çœŸå®è½¶äº‹ã€ç”Ÿæ´»ç±»æ¯”æˆ–æƒ³è±¡æ€§çš„ç»†èŠ‚æ¥å¼ºåŒ–è®²è§£ã€‚
        3. ä¸»æŒäººAè´Ÿè´£è®²è§£å†…å®¹ï¼Œä¸»æŒäººBè´Ÿè´£ç©¿æ’ç–‘é—®ã€ååº”å’Œæ¨åŠ¨èŠ‚å¥ã€‚
         â€¢ ä¸»æŒäººBçš„é—®é¢˜è¦æœ‰â€œå±•å¼€æ€§â€ï¼Œä¸èƒ½åªæ˜¯â€œé‚£è¿™ä¸ªæ˜¯å•¥ï¼Ÿâ€è€Œåº”å¦‚ï¼šâ€œæ‰€ä»¥å¦‚æœæŠŠå®ƒç±»æ¯”æˆå­¦æ ¡é‡Œçš„é£Ÿå ‚ç³»ç»Ÿï¼Œå®ƒæ˜¯ç®¡å•¥çš„ï¼Ÿâ€
         â€¢ ä¸»æŒäººB çš„æ’è¯å’Œæƒ…ç»ªè¡¨è¾¾éœ€è‡ªç„¶ï¼Œä¸è¦é¢‘ç¹ï¼Œä½†è¦åœ¨å…³é”®å¤„ç‚¹äº®æƒ…ç»ªã€‚
        4. å‰§æœ¬ä»¥ä¸»æŒäººAçš„æ€»ç»“æ€§å‘è¨€ç»“æŸï¼Œå¼ºè°ƒè®¨è®ºè¦ç‚¹å’Œå¯¹å¬ä¼—çš„å¯å‘ã€‚
        5. è¯­è¨€èŠ‚å¥éœ€å£è¯­åŒ–ã€è‡ªç„¶ã€æœ‰å±‚æ¬¡æ„Ÿã€‚é¿å…ä¹¦é¢è…”æˆ–ä¿¡æ¯å †å ã€‚
        6. è¾“å‡ºæ ¼å¼å¿…é¡»å¦‚ä¸‹ï¼Œä¸”ä¸è¦æ·»åŠ å¤šä½™è§£é‡Šï¼š
        [
            ("ä¸»æŒäººA", "æ’­å®¢å¼€åœºç™½..."),
            ("ä¸»æŒäººB", "ç–‘é—®æˆ–ååº”..."),
            ("ä¸»æŒäººA", "è§£é‡Šæˆ–è®²è¿°..."),
            ...
        ]

        ç¤ºä¾‹è¾“å…¥ï¼š
        [
            ("ä¸»æŒäººA", "æ¬¢è¿æ”¶å¬æˆ‘ä»¬çš„æ’­å®¢èŠ‚ç›®ï¼Œè¿™é‡Œæˆ‘ä»¬å°†æ¢è®¨ AI å’Œç§‘æŠ€é¢†åŸŸçš„æœ€æ–°çªç ´ã€‚æˆ‘æ˜¯ä½ çš„ä¸»æŒäººï¼Œä»Šå¤©æˆ‘ä»¬è¯·åˆ°äº†ä¸€ä½ AI é¢†åŸŸçš„çŸ¥åä¸“å®¶ï¼Œæˆ‘ä»¬å°†ä¸€èµ·æ·±å…¥äº†è§£ Meta AI æœ€æ–°å‘å¸ƒçš„ Llama 3.2ã€‚"),
            ("ä¸»æŒäººB", "å—¨ï¼Œæˆ‘çœŸçš„è¶…å…´å¥‹èƒ½æ¥åˆ°è¿™é‡Œï¼æ‰€ä»¥ï¼ŒLlama 3.2 åˆ°åº•æ˜¯å•¥ï¼Ÿ")
        ]

        ä½ çš„è¾“å‡ºåº”å½“æ˜¯ï¼š
        â€¢ é‡æ–°ç¼–å†™è¿™æ®µå†…å®¹ï¼Œä½¿å…¶æ›´åƒä¸€æ®µå¥¥æ–¯å¡çº§çš„ AI æ’­å®¢å‰§æœ¬ã€‚
        â€¢ èå…¥ç»†èŠ‚ã€é£æ ¼ã€æƒ…ç»ªã€‚
        â€¢ è§’è‰²å¯¹è¯è‡ªç„¶ã€èŠ‚å¥æœ‰è¶£ã€‚
    '''
    prompt = re.sub(r"<think>.*?</think>", "", prompt, flags=re.DOTALL).strip()
    prompt = prompt + "\nno_think"

    completion = client.chat.completions.create(
        model="qwen",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": prompt},
        ],
        temperature=0.7,
    )

    print("process 2 done!")

    text = re.sub(r"<think>.*?</think>", "", completion.choices[0].message.content, flags=re.DOTALL).strip()
    print(text)

    pipeline = KPipeline(
        lang_code='z', 
        repo_id='hexgrad/Kokoro-82M-v1.1-zh',
    )

    with sf.SoundFile(args.output, 'w', samplerate=24000, channels=1) as f: 
        for line in text.split("\n"):
            if not line.strip():
                continue
            match = re.match(r'\s*\(\s*"(.*?)"\s*,\s*"(.*?)"\s*\)\s*,?\s*', line)
            if match:
                speaker = match.group(1)
                text = match.group(2)
                if speaker == "ä¸»æŒäººA":
                    speaker = "zm_056"
                elif speaker == "ä¸»æŒäººB":
                    speaker = "zf_028"
                else:
                    continue
                # Generate the audio
                generator = pipeline(
                    text, voice=speaker, # <= change voice here
                    speed=1, split_pattern=r'\n+'
                )

                # Play the audio
                for _, (_, _, audio) in enumerate(generator):
                    f.write(audio)

    print("tts done!")

    samplerate, data = wav.read(args.output)
    sd.play(data, samplerate)
    sd.wait()
